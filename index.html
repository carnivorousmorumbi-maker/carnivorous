<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Carnivorous</title>

<!-- CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAR8CwWiIzxPP1Ly2LVWpbXRQYzUzi-JhY"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
}

header {
  padding: 20px;
  border-bottom: 2px solid #111;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

header h1 {
  width: 100%;
  margin: 0;
}

header input, header select {
  padding: 8px;
  border-radius: 6px;
  border: none;
}

#produtos { padding: 20px; }

.categoria {
  margin-top: 30px;
}

.categoria h2 {
  border-bottom: 2px solid #333;
}

.produto {
  border-bottom: 1px solid #222;
  padding: 10px 0;
}

.controle button {
  background: #ffcc00;
  color: #000;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  padding: 4px 12px;
  font-size: 18px;
  cursor: pointer;
}

#botaoCarrinho {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #25d366;
  color: #000;
  padding: 15px;
  border-radius: 14px;
  cursor: pointer;
  font-weight: bold;
  text-align: center;
}

#carrinho {
  display: none;
  position: fixed;
  inset: 0;
  background: #000;
  padding: 20px;
  overflow: auto;
}

#carrinho button {
  width: 100%;
  margin-top: 10px;
  padding: 12px;
  font-size: 16px;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}

.amarelo { background: #ffcc00; color: #000; }
.verde { background: #25d366; color: #000; }
.cinza { background: #333; color: #fff; }

input[type="text"] {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  border: none;
}
</style>
</head>

<body>

<header>
  <h1>CARNIVOROUS</h1>
  <input id="busca" placeholder="Buscar produto..." onkeyup="filtrarProdutos()">
  <select id="filtroCategoria" onchange="filtrarProdutos()"></select>
</header>

<div id="produtos"></div>

<div id="botaoCarrinho" onclick="abrirCarrinho()">
ðŸ›’ <span id="qtdCarrinho">0</span><br>
<span id="totalCarrinho">R$ 0,00</span>
</div>

<div id="carrinho">
  <h2>Carrinho</h2>
  <div id="conteudoCarrinho"></div>
  <button class="amarelo" onclick="escolherEntrega()">Finalizar pedido</button>
  <button class="cinza" onclick="fecharCarrinho()">Fechar</button>
</div>

<script>
/* ===== ELEMENTOS ===== */
const produtosDiv = document.getElementById("produtos");
const carrinhoDiv = document.getElementById("carrinho");
const conteudoCarrinho = document.getElementById("conteudoCarrinho");
const qtdCarrinho = document.getElementById("qtdCarrinho");
const totalCarrinho = document.getElementById("totalCarrinho");
const filtroCategoria = document.getElementById("filtroCategoria");
const busca = document.getElementById("busca");

/* ===== CONFIG ===== */
const PLANILHA =
"https://docs.google.com/spreadsheets/d/15osZ7x4v43t8yFdOs90W4oQnHdY-CJvF3qnTEz1SKjQ/pub?output=csv";

const ENDERECO_LOJA = "Rua David Ben Gurion, 1074, Jardim Monte Kemel, SÃ£o Paulo - SP";
const TAXA_POR_KM = 5;
const WHATSAPP_LOJA = "5511999562721";

/* ===== DADOS ===== */
let listaProdutos = [];
let carrinho = {};
let totalProdutos = 0;

/* ===== CARREGAR PRODUTOS (ROBUSTO) ===== */
Papa.parse(PLANILHA, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(res) {

    listaProdutos = res.data.map(l => {
      const nome =
        l["DescriÃ§Ã£o do Produto"] ||
        l["Descricao do Produto"] ||
        l["Produto"] ||
        l["Nome"];

      const categoria =
        l["Categoria"] ||
        "Outros";

      const valor =
        l["Valor Venda"] ||
        l["Valor de Venda"] ||
        l["PreÃ§o"] ||
        l["Preco"];

      if (!nome || !valor) return null;

      return {
        nome: nome.trim(),
        categoria: categoria.trim(),
        preco: Number(
          String(valor)
            .replace("R$", "")
            .replace(/\./g, "")
            .replace(",", ".")
        )
      };
    }).filter(p => p && !isNaN(p.preco));

    carregarCategorias();
    renderizarProdutos();
  }
});

/* ===== FUNÃ‡Ã•ES ===== */
function carregarCategorias() {
  filtroCategoria.innerHTML = `<option value="">Categorias</option>`;
  [...new Set(listaProdutos.map(p => p.categoria))].forEach(c => {
    filtroCategoria.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

function renderizarProdutos(lista = listaProdutos) {
  produtosDiv.innerHTML = "";
  const grupos = {};

  lista.forEach(p => {
    grupos[p.categoria] = grupos[p.categoria] || [];
    grupos[p.categoria].push(p);
  });

  for (let cat in grupos) {
    produtosDiv.innerHTML += `<div class="categoria"><h2>${cat}</h2></div>`;
    grupos[cat].forEach(p => {
      const id = p.nome.replace(/\W/g,"");
      produtosDiv.innerHTML += `
        <div class="produto">
          <b>${p.nome}</b><br>
          R$ ${p.preco.toFixed(2)}
          <div class="controle">
            <button onclick="remover('${p.nome}')">âˆ’</button>
            <span id="qtd-${id}">0</span>
            <button onclick="adicionar('${p.nome}', ${p.preco})">+</button>
          </div>
        </div>
      `;
    });
  }
}

function adicionar(nome, preco) {
  carrinho[nome] = carrinho[nome] || { qtd: 0, preco };
  carrinho[nome].qtd++;
  atualizarCarrinho();
}

function remover(nome) {
  if (!carrinho[nome]) return;
  carrinho[nome].qtd--;
  if (carrinho[nome].qtd <= 0) delete carrinho[nome];
  atualizarCarrinho();
}

function atualizarCarrinho() {
  let qtd = 0;
  let total = 0;

  document.querySelectorAll('[id^="qtd-"]').forEach(e => e.innerText = "0");

  for (let i in carrinho) {
    qtd += carrinho[i].qtd;
    total += carrinho[i].qtd * carrinho[i].preco;
    const el = document.getElementById("qtd-" + i.replace(/\W/g,""));
    if (el) el.innerText = carrinho[i].qtd;
  }

  qtdCarrinho.innerText = qtd;
  totalCarrinho.innerText = "R$ " + total.toFixed(2);
  totalProdutos = total;
}

/* ===== FLUXO ENTREGA ===== */
function abrirCarrinho() {
  let html = "";
  for (let i in carrinho) {
    const sub = carrinho[i].qtd * carrinho[i].preco;
    html += `${carrinho[i].qtd}x <b>${i}</b> â€” R$ ${sub.toFixed(2)}<br>`;
  }
  html += `<hr><b>Total produtos: R$ ${totalProdutos.toFixed(2)}</b>`;
  conteudoCarrinho.innerHTML = html;
  carrinhoDiv.style.display = "block";
}

function fecharCarrinho() {
  carrinhoDiv.style.display = "none";
}

function escolherEntrega() {
  conteudoCarrinho.innerHTML = `
    <h3>Entrega ou Retirada?</h3>
    <button class="verde" onclick="pedirEndereco()">Entrega</button>
    <button class="amarelo" onclick="finalizarWhats('Retirada',0,'')">Retirada</button>
  `;
}

function pedirEndereco() {
  conteudoCarrinho.innerHTML = `
    <h3>EndereÃ§o para entrega</h3>
    <input type="text" id="enderecoCliente" placeholder="Digite o endereÃ§o completo">
    <button class="verde" onclick="calcularEntrega()">Calcular taxa</button>
  `;
}

function calcularEntrega() {
  const endereco = document.getElementById("enderecoCliente").value;
  const service = new google.maps.DistanceMatrixService();

  service.getDistanceMatrix({
    origins: [ENDERECO_LOJA],
    destinations: [endereco],
    travelMode: 'DRIVING'
  }, (res, status) => {
    if (status !== "OK") {
      alert("Erro ao calcular distÃ¢ncia");
      return;
    }

    const km = res.rows[0].elements[0].distance.value / 1000;
    const taxa = km * TAXA_POR_KM;

    finalizarWhats("Entrega", taxa, endereco);
  });
}

function finalizarWhats(tipo, taxa, endereco) {
  let msg = "Pedido:%0A";
  for (let i in carrinho) {
    const sub = carrinho[i].qtd * carrinho[i].preco;
    msg += `${carrinho[i].qtd}x ${i} - R$ ${sub.toFixed(2)}%0A`;
  }

  msg += `%0ATotal produtos: R$ ${totalProdutos.toFixed(2)}`;

  if (tipo === "Entrega") {
    msg += `%0ATaxa entrega: R$ ${taxa.toFixed(2)}`;
    msg += `%0AEndereÃ§o: ${endereco}`;
  }

  msg += `%0ATotal final: R$ ${(totalProdutos + taxa).toFixed(2)}`;

  window.open(`https://wa.me/${WHATSAPP_LOJA}?text=${msg}`, "_blank");
}

function filtrarProdutos() {
  const texto = busca.value.toLowerCase();
  const cat = filtroCategoria.value;

  renderizarProdutos(
    listaProdutos.filter(p =>
      p.nome.toLowerCase().includes(texto) &&
      (!cat || p.categoria === cat)
    )
  );
}
</script>

</body>
</html>
