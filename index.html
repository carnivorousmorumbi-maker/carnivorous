<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Carnivorous</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAR8CwWiIzxPP1Ly2LVWpbXRQYzUzi-JhY&libraries=places"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
}

header {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 20px;
  border-bottom: 2px solid #111;
}

header img { height: 70px; }

header input, header select {
  padding: 8px;
  border-radius: 6px;
  border: none;
}

#produtos { padding: 20px; }

.categoria h2 {
  border-bottom: 2px solid #333;
}

.produto {
  border-bottom: 1px solid #222;
  padding: 10px 0;
}

.controle button {
  background: #ffcc00;
  color: #000;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  padding: 4px 12px;
  font-size: 18px;
  cursor: pointer;
}

#botaoCarrinho {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #25d366;
  color: #000;
  padding: 15px;
  border-radius: 14px;
  cursor: pointer;
  font-weight: bold;
}

#carrinho {
  display: none;
  position: fixed;
  inset: 0;
  background: #000;
  padding: 20px;
  overflow: auto;
}

#carrinho button {
  width: 100%;
  margin-top: 10px;
  padding: 12px;
  font-size: 16px;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}

.amarelo { background: #ffcc00; color: #000; }
.verde { background: #25d366; color: #000; }
.cinza { background: #333; color: #fff; }
</style>
</head>

<body>

<header>
  <h1>CARNIVOROUS</h1>
  <input id="busca" placeholder="Buscar..." onkeyup="filtrarProdutos()">
  <select id="filtroCategoria" onchange="filtrarProdutos()"></select>
</header>

<div id="produtos"></div>

<div id="botaoCarrinho" onclick="abrirCarrinho()">
üõí <span id="qtdCarrinho">0</span><br>
<span id="totalCarrinho">R$ 0,00</span>
</div>

<div id="carrinho">
  <h2>Carrinho</h2>
  <div id="conteudoCarrinho"></div>
  <button class="amarelo" onclick="escolherEntrega()">Finalizar pedido</button>
  <button class="cinza" onclick="fecharCarrinho()">Fechar</button>
</div>

<script>
const PLANILHA =
"https://docs.google.com/spreadsheets/d/15osZ7x4v43t8yFdOs90W4oQnHdY-CJvF3qnTEz1SKjQ/pub?output=csv";

const ENDERECO_LOJA = "Rua David Ben Gurion, 1074, Jardim Monte Kemel, S√£o Paulo - SP";
const TAXA_POR_KM = 5;
const WHATSAPP_LOJA = "5511999562721";

let listaProdutos = [];
let carrinho = {};
let totalProdutos = 0;

Papa.parse(PLANILHA, {
  download: true,
  header: true,
  complete: res => {
    listaProdutos = res.data.filter(p => p["Descri√ß√£o do Produto"]).map(p => ({
      nome: p["Descri√ß√£o do Produto"],
      categoria: p["Categoria"],
      preco: parseFloat(String(p["Valor Venda"]).replace(".", "").replace(",", "."))
    }));
    carregarCategorias();
    renderizarProdutos();
  }
});

function carregarCategorias() {
  filtroCategoria.innerHTML = `<option value="">Categorias</option>`;
  [...new Set(listaProdutos.map(p => p.categoria))].forEach(c =>
    filtroCategoria.innerHTML += `<option>${c}</option>`
  );
}

function renderizarProdutos(lista = listaProdutos) {
  produtos.innerHTML = "";
  const grupo = {};
  lista.forEach(p => (grupo[p.categoria] = grupo[p.categoria] || []).push(p));
  for (let c in grupo) {
    produtos.innerHTML += `<div class="categoria"><h2>${c}</h2></div>`;
    grupo[c].forEach(p => {
      const id = p.nome.replace(/\W/g,"");
      produtos.innerHTML += `
      <div class="produto">
        <b>${p.nome}</b><br>R$ ${p.preco.toFixed(2)}
        <div class="controle">
          <button onclick="remover('${p.nome}')">‚àí</button>
          <span id="qtd-${id}">0</span>
          <button onclick="adicionar('${p.nome}',${p.preco})">+</button>
        </div>
      </div>`;
    });
  }
}

function adicionar(nome, preco) {
  carrinho[nome] = carrinho[nome] || {qtd:0,preco};
  carrinho[nome].qtd++;
  atualizar();
}

function remover(nome) {
  if (!carrinho[nome]) return;
  carrinho[nome].qtd--;
  if (carrinho[nome].qtd <= 0) delete carrinho[nome];
  atualizar();
}

function atualizar() {
  let q=0, t=0;
  document.querySelectorAll('[id^="qtd-"]').forEach(e=>e.innerText="0");
  for (let i in carrinho) {
    q+=carrinho[i].qtd;
    t+=carrinho[i].qtd*carrinho[i].preco;
    document.getElementById("qtd-"+i.replace(/\W/g,"")).innerText=carrinho[i].qtd;
  }
  qtdCarrinho.innerText=q;
  totalCarrinho.innerText="R$ "+t.toFixed(2);
  totalProdutos = t;
}

function abrirCarrinho() {
  let html="", total=0;
  for (let i in carrinho) {
    let s=carrinho[i].qtd*carrinho[i].preco;
    total+=s;
    html+=`${carrinho[i].qtd}x <b>${i}</b> - R$ ${s.toFixed(2)}<br>`;
  }
  html+=`<hr><b>Total produtos: R$ ${total.toFixed(2)}</b>`;
  conteudoCarrinho.innerHTML=html;
  carrinho.style.display="block";
}

function fecharCarrinho(){ carrinho.style.display="none"; }

function escolherEntrega(){
  conteudoCarrinho.innerHTML=`
    <h3>Entrega ou Retirada?</h3>
    <button class="verde" onclick="pedirEndereco()">Entrega</button>
    <button class="amarelo" onclick="escolherPagamento('Retirada',0)">Retirada</button>
  `;
}

function pedirEndereco(){
  conteudoCarrinho.innerHTML=`
    <h3>Endere√ßo para entrega</h3>
    <input id="enderecoCliente" placeholder="Digite o endere√ßo completo">
    <button class="verde" onclick="calcularEntrega()">Calcular taxa</button>
  `;
}

function calcularEntrega(){
  const endereco = enderecoCliente.value;
  const service = new google.maps.DistanceMatrixService();
  service.getDistanceMatrix({
    origins:[ENDERECO_LOJA],
    destinations:[endereco],
    travelMode:'DRIVING'
  }, (res,status)=>{
    if(status!=="OK"){ alert("Erro ao calcular dist√¢ncia"); return;}
    const km = res.rows[0].elements[0].distance.value / 1000;
    const taxa = km * TAXA_POR_KM;
    escolherPagamento("Entrega", taxa, endereco, km);
  });
}

function escolherPagamento(tipo, taxa=0, endereco="", km=0){
  conteudoCarrinho.innerHTML=`
    <h3>${tipo}</h3>
    ${tipo==="Entrega" ? `<p>Dist√¢ncia: ${km.toFixed(2)} km<br>Taxa: R$ ${taxa.toFixed(2)}</p>` : ""}
    <h3>Forma de pagamento</h3>
    <button onclick="finalizar('${tipo}','Vale Alimenta√ß√£o',${taxa},'${endereco}')">Vale Alimenta√ß√£o</button>
    <button onclick="finalizar('${tipo}','D√©bito',${taxa},'${endereco}')">D√©bito</button>
    <button onclick="finalizar('${tipo}','Cr√©dito',${taxa},'${endereco}')">Cr√©dito</button>
    <button onclick="finalizar('${tipo}','Pix',${taxa},'${endereco}')">Pix</button>
  `;
}

function finalizar(tipo, pagamento, taxa, endereco){
  let msg="Pedido:%0A";
  for(let i in carrinho){
    let s=carrinho[i].qtd*carrinho[i].preco;
    msg+=`${carrinho[i].qtd}x ${i} - R$ ${s.toFixed(2)}%0A`;
  }
  let total = totalProdutos + taxa;
  msg+=`%0ATotal produtos: R$ ${totalProdutos.toFixed(2)}`;
  if(tipo==="Entrega"){
    msg+=`%0ATaxa entrega: R$ ${taxa.toFixed(2)}`;
    msg+=`%0AEndere√ßo: ${endereco}`;
  }
  msg+=`%0ATotal final: R$ ${total.toFixed(2)}`;
  msg+=`%0APagamento: ${pagamento}`;

  window.open(`https://wa.me/${WHATSAPP_LOJA}?text=${msg}`,"_blank");
}

function filtrarProdutos(){
  const t=busca.value.toLowerCase();
  const c=filtroCategoria.value;
  renderizarProdutos(listaProdutos.filter(p =>
    p.nome.toLowerCase().includes(t) && (!c || p.categoria===c)
  ));
}
</script>

</body>
</html>
